name: Test Matrix Sleep
on:
  workflow_dispatch:
    inputs:
      sleep-seconds:
        required: true

jobs:
  init:
    runs-on: ubuntu-latest
    steps:
      - name: Echo inputs
        run: echo '${{ toJSON(inputs) }}'

      - name: Sleep for ${{ inputs.sleep-seconds }}
        run: sleep ${{ inputs.sleep-seconds }}

  matrix:
    needs:
      - init
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        seconds: [1, 2, 3]
    steps:
      - name: Echo inputs
        run: echo '${{ toJSON(inputs) }}'

      - name: Dump GitHub context
        run: echo '${{ toJSON(github) }}'

      - name: Dump job context
        run: echo '${{ toJSON(job) }}'

      - name: Maybe fail
        run: |
          if [[ $(($RANDOM % 10 )) -gt 2 ]]; then
              exit 0
          else
              exit 1
          fi

      - name: Sleep for ${{ matrix.seconds }} seconds
        run: |
          sleep ${{ matrix.seconds }}

  post-matrix:
    needs:
      - matrix
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: All matrix jobs successful
        if: ${{ !(contains(needs.*.result, 'failure')) }}
        run: exit 0

      - name: Some matrix jobs failed
        if: ${{ contains(needs.*.result, 'failure') }}
        run: exit 1
